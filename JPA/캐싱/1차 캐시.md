# 1차 캐시 (1L cache)

: 영속성 컨텍스트 내부에 엔티티를 보관하는 저장소

- Hibernate가 **기본으로 제공**하는 캐시
- **객체의 동일성 보장** ex) 객체1 == 객체2
- 애플리케이션 전체로 봐서 **DB 접근 횟수를 줄이지는 못함**
- **영속성 컨텍스트 == 1차 캐시**
- **영속성 컨텍스트 내부**에 존재함
  - 영속성 컨텍스트 생명주기와 동일 → 트랜잭션 종료 시 1차 캐시도 종료됨
  - OSIV를 사용해도 사용자의 요청이 들어올 때부터 끝날 때까지만 1차 캐시가 유효함
  **OSIV?** (Open Session In View)
  - 영속성 컨텍스트를 뷰까지 열어두는 기능 → 엔티티도 영속성 상태 유지
  - 뷰까지 영속성 컨텍스트가 살아있다면 뷰에서도 지연로딩 사용 가능

## 동작 방식

**데이터가 1차 캐시에 없을 때**

---

1. 최초 조회 시 엔티티가 없으므로 DB 데이터를 조회함
2. DB에서 조회해온 데이터를 영속성 컨텍스트 내부 저장소(1차 캐시)에 보관함
3. 1차 캐시에 있는 데이터를 반환함

**데이터가 1차 캐시에 있을 때**

---

1차 캐시(영속성 컨텍스트)에 데이터가 있으므로 데이터를 반환함(DB 조회 안함)

### 주의사항

---

- EntityManager를 통해 save 하면 영속성 컨텍스트에 저장됨 → JPQL을 사용할 경우 DB 먼저 조회
- 호출 순서
  1. JPQL을 사용해 DB 조회
  2. 조회한 결과를 영속성 컨텍스트에 저장 시도
  3. 영속성 컨텍스트에 조회 결과가 있다면 DB에서 조회한 데이터 버림
